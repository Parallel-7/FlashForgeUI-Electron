<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1e1e1e">
  <title>FlashForge Web UI</title>
  <link rel="stylesheet" href="gridstack.min.css">
  <link rel="stylesheet" href="gridstack-extra.min.css">
  <link rel="stylesheet" href="webui.css">
</head>
<body>
  <div class="app-container">
    <!-- Login Screen (initially visible) -->
    <div id="login-screen" class="login-screen">
      <div class="login-container">
        <h1>FlashForge Web UI</h1>
        <div class="login-form">
          <input type="password" id="password-input" placeholder="Enter password" autocomplete="current-password">
          <div class="remember-me">
            <label>
              <input type="checkbox" id="remember-me-checkbox">
              <span>Remember me</span>
            </label>
          </div>
          <button id="login-button">Login</button>
        </div>
        <div id="login-error" class="login-error"></div>
      </div>
    </div>

    <!-- Main UI (initially hidden) -->
    <div id="main-ui" class="main-ui hidden">
      <!-- Header Bar -->
      <div class="header">
        <div class="header-left">
          <div class="header-title">FlashForge Web UI</div>
        </div>
        <div class="header-center">
          <!-- Printer Selector (hidden when only one printer) -->
          <div class="printer-selector hidden" id="printer-selector">
            <label for="printer-select">Printer:</label>
            <select id="printer-select" class="printer-select">
              <option value="">Loading...</option>
            </select>
          </div>
        </div>
        <div class="header-right">
          <button id="edit-mode-toggle" class="edit-mode-toggle" aria-pressed="false">
            <span class="lock-icon" aria-hidden="true">ðŸ”’</span>
            <span class="edit-text">Locked</span>
          </button>
          <button
            id="settings-button"
            class="settings-button"
            aria-haspopup="dialog"
            aria-controls="settings-modal"
            title="WebUI Settings"
          >
            <svg viewBox="0 0 24 24" role="img" aria-label="Settings">
              <path
                d="M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.07-.94l2.03-1.58a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.61-.22l-2.39.96a7.057 7.057 0 0 0-1.62-.94l-.36-2.54A.5.5 0 0 0 13.9 2h-3.8a.5.5 0 0 0-.5.42l-.36 2.54c-.6.24-1.15.56-1.66.94l-2.39-.96a.5.5 0 0 0-.61.22L2.66 8.48a.5.5 0 0 0 .12.64l2.03 1.58c-.05.31-.07.64-.07.97s.02.63.07.94l-2.03 1.58a.5.5 0 0 0-.12.64l1.92 3.32c.14.24.43.34.69.22l2.39-.96c.5.38 1.05.7 1.66.94l.36 2.54c.05.26.26.44.5.44h3.8c.25 0 .46-.18.5-.42l.36-2.54c.6-.24 1.15-.56 1.66-.94l2.39.96c.25.12.55.02.69-.22l1.92-3.32a.5.5 0 0 0-.12-.64l-2.03-1.58ZM12 15.5A3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7Z"
              ></path>
            </svg>
          </button>
          <div class="connection-status">
            <span class="connection-indicator" id="connection-indicator"></span>
            <span id="connection-text">Disconnected</span>
          </div>
          <button id="logout-button" class="logout-button">Logout</button>
        </div>
      </div>

      <!-- Main Layout -->
      <div class="main-layout">
        <!-- Desktop GridStack Layout -->
        <div class="grid-stack webui-grid webui-grid-desktop" id="webui-grid-desktop" aria-live="polite">
          <!-- Components injected dynamically via WebUIGridManager -->
        </div>

        <!-- Mobile Static Layout (hidden on desktop) -->
        <div class="webui-grid webui-grid-mobile hidden" id="webui-grid-mobile" aria-live="polite">
          <!-- Components injected in predefined mobile order -->
        </div>
      </div>

      <!-- Settings Modal -->
      <div id="settings-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="settings-modal-title">
        <div class="modal-content large">
          <div class="modal-header">
            <h2 id="settings-modal-title">WebUI Settings</h2>
            <button id="close-settings" class="close-btn" aria-label="Close settings">&times;</button>
          </div>
          <div class="modal-body">
            <section class="settings-section">
              <h3>Panel Visibility</h3>
              <label><input type="checkbox" id="toggle-camera" data-component-id="camera" checked> Camera View</label>
              <label><input type="checkbox" id="toggle-controls" data-component-id="controls" checked> Controls</label>
              <label><input type="checkbox" id="toggle-model-preview" data-component-id="model-preview" checked> Model Preview</label>
              <label><input type="checkbox" id="toggle-printer-state" data-component-id="printer-state" checked> Printer State</label>
              <label><input type="checkbox" id="toggle-temp-control" data-component-id="temp-control" checked> Temperature Control</label>
              <label><input type="checkbox" id="toggle-filtration-tvoc" data-component-id="filtration-tvoc" checked> Filtration &amp; TVOC</label>
              <label><input type="checkbox" id="toggle-job-progress" data-component-id="job-progress" checked> Job Progress</label>
              <label><input type="checkbox" id="toggle-job-details" data-component-id="job-details" checked> Job Details</label>
            </section>
            <section class="settings-section">
              <h3>Layout Customization</h3>
              <label class="toggle-edit-mode">
                <input type="checkbox" id="toggle-edit-mode">
                <span>Enable Edit Mode</span>
                <span class="help-text">Allows dragging and resizing panels</span>
              </label>
            </section>
            <section class="settings-section">
              <h3>Reset</h3>
              <button id="reset-layout-btn" class="secondary-btn">Reset Layout to Default</button>
            </section>
          </div>
          <div class="modal-footer">
            <button id="save-settings-btn" class="primary-btn">Save</button>
          </div>
        </div>
      </div>

      <!-- File Selection Modal -->
      <div id="file-modal" class="modal hidden">
        <div class="modal-content">
          <div class="modal-header">
            <h2 id="modal-title">Select File</h2>
            <button id="close-modal" class="close-btn">&times;</button>
          </div>
          <div class="modal-body">
            <div id="file-list" class="file-list"></div>
          </div>
          <div class="modal-footer">
            <label class="checkbox-label">
              <input type="checkbox" id="auto-level">
              <span>Auto Level</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="start-now" checked>
              <span>Start Now</span>
            </label>
            <button id="print-file-btn" class="primary-btn" disabled>Print</button>
          </div>
        </div>
      </div>

      <!-- Material Matching Modal -->
      <div id="material-matching-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="material-matching-title">
        <div class="modal-content material-matching">
          <div class="modal-header">
            <h2 id="material-matching-title">Match Materials</h2>
            <button id="material-matching-close" class="close-btn" aria-label="Close material matching">&times;</button>
          </div>
          <div class="modal-body">
            <p class="material-matching-description">
              Match each material used in your print to the corresponding material station slot. Material types must match (for example, PLA to PLA).
            </p>
            <div id="material-matching-error" class="material-matching-message error hidden" role="alert"></div>
            <div id="material-matching-warning" class="material-matching-message warning hidden" role="status"></div>
            <div class="material-matching-layout">
              <section class="material-column">
                <h3>Job Requirements</h3>
                <div id="material-job-requirements" class="material-list"></div>
              </section>
              <section class="material-column">
                <h3>Material Station</h3>
                <div id="material-slot-list" class="material-list"></div>
              </section>
            </div>
            <section class="material-mappings-section">
              <h3>Current Mappings</h3>
              <div id="material-mappings" class="material-mappings"></div>
            </section>
          </div>
          <div class="modal-footer">
            <button id="material-matching-cancel" class="secondary-btn" type="button">Cancel</button>
            <button id="material-matching-confirm" class="primary-btn" type="button" disabled>Start Print</button>
          </div>
        </div>
      </div>

      <!-- Temperature Input Dialog -->
      <div id="temp-dialog" class="modal hidden">
        <div class="modal-content small">
          <div class="modal-header">
            <h2 id="temp-dialog-title">Set Temperature</h2>
            <button id="close-temp-dialog" class="close-btn">&times;</button>
          </div>
          <div class="modal-body">
            <p id="temp-dialog-message">Enter temperature (Â°C):</p>
            <input type="number" id="temp-input" min="0" max="300" step="5" value="0">
          </div>
          <div class="modal-footer">
            <button id="temp-cancel" class="secondary-btn">Cancel</button>
            <button id="temp-confirm" class="primary-btn">Set</button>
          </div>
        </div>
      </div>

      <!-- Toast Notification -->
      <div id="toast" class="toast hidden"></div>
    </div>
  </div>

  <!-- JSMpeg library for RTSP streaming (vendored locally) -->
  <script src="jsmpeg.min.js"></script>

  <!-- GridStack library for drag-and-drop layout management -->
  <script src="gridstack-all.js"></script>

  <!-- TypeScript compiled to JavaScript -->
  <script type="module" src="app.js"></script>
</body>
</html>
